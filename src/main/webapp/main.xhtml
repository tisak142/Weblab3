<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <h:head>
        <title>Main Page</title>
        <meta charset="UTF-8"/>
        <link rel="stylesheet" type="text/css" href="#{request.contextPath}/resources/css/main.css"/>
    </h:head>
    <h:body>
        <audio id="windowsSound" preload="auto">
            <source src="#{request.contextPath}/resources/audio/windows.mp3" type="audio/mpeg"/>
        </audio>
        <audio id="hitSound" preload="auto">
            <source src="#{request.contextPath}/resources/audio/break.mp3" type="audio/mpeg"/>
        </audio>
        <audio id="noHitSound" preload="auto">
            <source src="#{request.contextPath}/resources/audio/no-break.mp3" type="audio/mpeg"/>
        </audio>
        <audio id="clearValuesSound" preload="auto">
            <source src="#{request.contextPath}/resources/audio/minus3.mp3" type="audio/mpeg"/>
        </audio>
        <h:inputHidden id="lastHitResult" value="#{pointBean.lastHitResult}" />
        <div class="main-container">
            <div class="input-section">
                <h:panelGroup id="graph-container">
                    <svg width="300px" height="300px" id="graph" onclick="handleGraphClick(event)">

                        <line x1="150" y1="10" x2="150" y2="290" stroke="black" stroke-width="2"/>
                        <line x1="10" y1="150" x2="290" y2="150" stroke="black" stroke-width="2"/>
                        <polygon points="145, 15 150, 5 155, 15" fill="black"/>
                        <polygon points="290, 145 300 150 290, 155" fill="black"/>

                        <line x1="50" y1="145" x2="50" y2="155" stroke="black" stroke-width="2"/>
                        <line x1="100" y1="145" x2="100" y2="155" stroke="black" stroke-width="2"/>
                        <line x1="200" y1="145" x2="200" y2="155" stroke="black" stroke-width="2"/>
                        <line x1="250" y1="145" x2="250" y2="155" stroke="black" stroke-width="2"/>
                        <line y1="50" x1="145" y2="50" x2="155" stroke="black" stroke-width="2"/>
                        <line y1="100" x1="145" y2="100" x2="155" stroke="black" stroke-width="2"/>
                        <line y1="200" x1="145" y2="200" x2="155" stroke="black" stroke-width="2"/>
                        <line y1="250" x1="145" y2="250" x2="155" stroke="black" stroke-width="2"/>

                        <rect class="square" x="50" y="150" width="100" height="50"/>
                        <path class="circle" d="M 150 50 A 100, 100 0, 0,1, 250, 150 L 150 150 Z" fill="orange"/>
                        <polygon class="triangle" points="100, 150 150, 150 150, 100"/>

                        <text x="39" y="140">-#{pointBean.r != null ? pointBean.r : 'R'}</text>
                        <text x="89" y="140">-#{pointBean.r != null ? pointBean.r / 2 : 'R/2'}</text>
                        <text x="197" y="140">#{pointBean.r != null ? pointBean.r / 2 : 'R/2'}</text>
                        <text x="247" y="140">#{pointBean.r != null ? pointBean.r: "R"}</text>
                        <text x="160" y="58">#{pointBean.r != null ? pointBean.r : 'R'}</text>
                        <text x="160" y="108">#{pointBean.r != null ? pointBean.r / 2 : 'R/2'}</text>
                        <text x="158" y="206">-#{pointBean.r != null ? pointBean.r / 2 : '-R/2'}</text>
                        <text x="158" y="256">-#{pointBean.r != null ? pointBean.r : 'R'}</text>

                        <ui:repeat value="#{pointBean.resultsForCurrentRadius}" var="result">
                            <circle cx="#{150 + (result.x / result.r) * 100}"
                                    cy="#{150 - (result.y / result.r) * 100}"
                                    r="3"
                                    fill="#{result.hit ? '#00ff00' : '#ff0000'}"
                                    class="result-point"
                                    title="X: #{result.x}, Y: #{result.y}, Hit: #{result.hit}"/>
                        </ui:repeat>

                    </svg>
                </h:panelGroup>
                <div class="input-section-text">
                    <h:form id="point-form">

                        <h:outputLabel for="x-input" styleClass="vars-label" value="Выберите координату X:"/>

                        <div id="x-input" class="x-vars">
                            <h:commandLink value="-2" styleClass="coordinate-button"
                                           action="#{pointBean.setX(-2.0)}" >
                                <f:ajax execute="@this" render="selected-x x-message"/>
                            </h:commandLink>
                            <h:commandLink value="-1.5" styleClass="coordinate-button"
                                           action="#{pointBean.setX(-1.5)}" >
                                <f:ajax execute="@this" render="selected-x x-message"/>
                            </h:commandLink>
                            <h:commandLink value="-1" styleClass="coordinate-button"
                                           action="#{pointBean.setX(-1.0)}" >
                                <f:ajax execute="@this" render="selected-x x-message"/>
                            </h:commandLink>
                            <h:commandLink value="-0.5" styleClass="coordinate-button"
                                           action="#{pointBean.setX(-0.5)}" >
                                <f:ajax execute="@this" render="selected-x x-message"/>
                            </h:commandLink>
                            <h:commandLink value="0" styleClass="coordinate-button"
                                           action="#{pointBean.setX(0.0)}" >
                                <f:ajax execute="@this" render="selected-x x-message x-message"/>
                            </h:commandLink>
                            <h:commandLink value="0.5" styleClass="coordinate-button"
                                           action="#{pointBean.setX(0.5)}" >
                                <f:ajax execute="@this" render="selected-x x-message x-message"/>
                            </h:commandLink>
                            <h:commandLink value="1" styleClass="coordinate-button"
                                           action="#{pointBean.setX(1.0)}" >
                                <f:ajax execute="@this" render="selected-x x-message x-message"/>
                            </h:commandLink>
                            <h:commandLink value="1.5" styleClass="coordinate-button"
                                           action="#{pointBean.setX(1.5)}" >
                                <f:ajax execute="@this" render="selected-x x-message x-message"/>
                            </h:commandLink>
                        </div>

                        <h:outputText id="selected-x" value="Выбран X: #{pointBean.x}"/>

                        <h:outputLabel for="y-input" styleClass="vars-label" value="Выберите координату Y:"/>
                        <div class="y-vars">
                            <h:inputText placeHolder="от -5 до 3" id="y-input" value="#{pointBean.y}" converter="doubleConverter"/>
                        </div>

                        <h:outputLabel for="r-input" styleClass="vars-label" value="Выберите координату R:"/>
                        <div id="r-input" class="r-vars">
                            <h:commandLink value="1.0" styleClass="coordinate-button"
                                           action="#{pointBean.setR(1.0)}" >
                                <f:ajax execute="@this" render=":graph-form:current-r selected-r r-message
                                 :graph-container :results-container"/>
                            </h:commandLink>
                            <h:commandLink value="2.0" styleClass="coordinate-button"
                                           action="#{pointBean.setR(2.0)}" >
                                <f:ajax execute="@this" render=":graph-form:current-r selected-r r-message
                                 :graph-container :results-container"/>
                            </h:commandLink>
                            <h:commandLink value="3.0" styleClass="coordinate-button"
                                           action="#{pointBean.setR(3.0)}" >
                                <f:ajax execute="@this" render=":graph-form:current-r selected-r r-message
                                :graph-container :results-container"/>
                            </h:commandLink>
                            <h:commandLink value="4.0" styleClass="coordinate-button"
                                           action="#{pointBean.setR(4.0)}" >
                                <f:ajax execute="@this" render=":graph-form:current-r selected-r r-message
                                :graph-container :results-container "/>
                            </h:commandLink>
                        </div>

                        <h:outputText id="selected-r" value="Выбран R: #{pointBean.r}"/>

                        <h:commandButton id="check-button" value="Check point"
                                         action="#{pointBean.checkHit}"
                                         styleClass="form-buttons">
                            <f:ajax execute="point-form lastHitResult"
                                    render=":point-form:all-messages :results-container :graph-container :clear-button-container lastHitResult"
                                    onevent="handleCheckResult"/>
                        </h:commandButton>

                        <h:commandButton id="reset-button" value="Reset values" action="#{pointBean.clear}"
                                         styleClass="form-buttons" onclick="makeNoiseValues(); return true;">
                            <f:ajax execute="point-form" render=":point-form:all-messages :point-form:selected-x
                            :point-form:selected-r :point-form:y-input
                            :graph-form:current-r :results-container :graph-container"/>

                        </h:commandButton>
                        <h:messages id="all-messages" globalOnly="false" styleClass="errors"
                                    showDetail="true" showSummary="false" layout="list"/>
                    </h:form>
                </div>
            </div>
            <div class="table-block">
                <h:panelGroup id="results-container">
                    <h:dataTable value="#{pointBean.results}" var="result"
                                 styleClass="points-table" rendered="#{pointBean.resultsCount > 0}">
                        <f:facet name="header">
                            <h:outputText value="История проверок (всего: #{pointBean.resultsCount})"/>
                        </f:facet>

                        <h:column>
                            <f:facet name="header">X</f:facet>
                            <h:outputText value="#{result.x}"/>
                        </h:column>

                        <h:column>
                            <f:facet name="header">Y</f:facet>
                            <h:outputText value="#{result.y}"/>
                        </h:column>

                        <h:column>
                            <f:facet name="header">R</f:facet>
                            <h:outputText value="#{result.r}"/>
                        </h:column>

                        <h:column>
                            <f:facet name="header">Результат</f:facet>
                            <h:outputText value="#{result.hit ? 'Попадание' : 'Промах'}"
                                          styleClass="#{result.hit ? 'hit' : 'miss'}"/>
                        </h:column>

                        <h:column>
                            <f:facet name="header">Время</f:facet>
                            <h:outputText value="#{result.timestamp}">
                                <f:convertDateTime pattern="dd.MM.yyyy HH:mm:ss"/>
                            </h:outputText>
                        </h:column>
                    </h:dataTable>
                </h:panelGroup>
                <div style="text-align: center; margin-top: 20px;">
                    <h:panelGroup id="clear-button-container">
                        <h:commandButton value="Очистить историю" action="#{pointBean.clearResults}"
                                         styleClass="buttons" rendered="#{pointBean.getResultsCount() > 0}"
                                         onclick="makeNoiseWindows(); return true;">
                            <f:ajax execute="@this" render="clear-button-container :results-container :graph-container
                             :point-form:all-messages"/>
                        </h:commandButton>
                    </h:panelGroup>
                </div>
            </div>
            <h:form id="graph-form" style="display: none;">
                <h:inputHidden id="graph-x" value="#{pointBean.graphX}"/>
                <h:inputHidden id="graph-y" value="#{pointBean.graphY}"/>
                <h:inputHidden id="current-r" value="#{pointBean.r}" />
                <h:commandButton id="graph-submit" value="Submit" action="#{pointBean.checkHitFromGraph}">
                    <f:ajax execute="graph-form" render=":point-form:all-messages :results-container
                    :graph-container :clear-button-container lastHitResult" onevent="handleCheckResult"/>
                </h:commandButton>
            </h:form>
        </div>
        <div class="link-to-clock">
            <h:link outcome="index" value="Перейти к часам" styleClass="nav-link"/>
        </div>
        <h:outputScript library="js" name="main.js"/>
    </h:body>
</html>